name: Simple CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  detect-affected-services:
    runs-on: ubuntu-latest
    outputs:
      affected: ${{ steps.set-affected.outputs.affected }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Detect affected services
        id: set-affected
        run: |
          echo "Detecting changed services..."
          # Get changed files between HEAD and base (for PRs) or last commit (for push)
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}
            CHANGED=$(git diff --name-only origin/${{ github.base_ref }})
          else
            CHANGED=$(git diff --name-only HEAD~1)
          fi
          echo "Changed files: $CHANGED"
          # Extract unique service directories
          SERVICES=""
          for file in $CHANGED; do
            if [[ $file == services/*/* ]]; then
              service=$(echo $file | cut -d'/' -f2)
              SERVICES+="$service "
            fi
          done
          # Remove duplicates
          SERVICES=$(echo $SERVICES | tr ' ' '\n' | sort -u | tr '\n' ' ')
          SERVICES=$(echo $SERVICES | xargs) # trim
          echo "Affected services: $SERVICES"
          echo "affected=$SERVICES" >> $GITHUB_OUTPUT

  build:
    needs: detect-affected-services
    runs-on: ubuntu-latest
    if: needs.detect-affected-services.outputs.affected != ''
    strategy:
      matrix:
        service: ${{ fromJson(format('[{0}]', needs.detect-affected-services.outputs.affected)) }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      - name: Build affected service
        run: |
          cd services/${{ matrix.service }}
          go build -v .
